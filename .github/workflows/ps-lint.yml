name: PowerShell Lint

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install PSScriptAnalyzer
      shell: pwsh
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
    
    - name: Run PSScriptAnalyzer
      shell: pwsh
      run: |
        $results = Invoke-ScriptAnalyzer -Path . -Recurse -IncludeDefaultRules
        if ($results) {
          $results | ForEach-Object {
            Write-Output "::$($_.Severity.ToString().ToLower())::$($_.ScriptName):$($_.Line):$($_.Column): $($_.Message)"
          }
          if ($results | Where-Object { $_.Severity -eq 'Error' }) {
            exit 1
          }
        }
